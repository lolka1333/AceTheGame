# Исправления вылетов ATG при выборе процесса для attach

## Проблема
ATG иногда вылетает при выборе процесса для attach. Причины были неизвестны, но после анализа кода выявлены следующие потенциальные проблемы:

## Выявленные проблемы и исправления

### 1. ACEAttachClient.kt - Проблемы с сокетами
**Проблема**: Отсутствовала обработка ошибок при создании сокета и подключении к серверу ACE. Также была логическая несогласованность - таймауты настраивались, но использовались DONTWAIT флаги, которые их игнорировали.

**Исправления**:
- Добавлены таймауты для отправки и получения данных (5 секунд)
- Добавлена обработка ошибок при подключении
- Добавлен таймаут для ожидания подключения (10 секунд)
- Улучшена обработка исключений в SendCommand
- Добавлена безопасная очистка ресурсов в методе close()
- Убраны ZMQ.DONTWAIT флаги для корректной работы таймаутов

### 2. ACEServer.kt - Проблемы с запуском сервера
**Проблема**: Не проверялся результат запуска ACE сервера.

**Исправления**:
- Добавлена проверка существования бинарного файла сервера
- Добавлена проверка успешности выполнения команды Shell.cmd()
- Добавлена обработка ошибок с подробным логированием
- Добавлена проверка кода завершения команды

### 3. Port.kt - Race condition при получении портов
**Проблема**: Порты сначала получались, затем освобождались, что создавало race condition. Также была ошибка компиляции с типами данных.

**Исправления**:
- Добавлен механизм повторных попыток (до 5 попыток)
- Добавлена обработка SocketException
- Добавлено логирование для отслеживания проблем
- Добавлена функция IsPortAvailable для проверки доступности портов
- Добавлен back-off механизм при неудачах
- Исправлены типы данных для Thread.sleep() (Int -> Long)

### 4. Cmd.kt - Отсутствие проверки кода завершения
**Проблема**: Не проверялся код завершения выполняемых команд.

**Исправления**:
- Добавлена проверка кода завершения процесса
- Добавлена обработка IOException и InterruptedException
- Добавлено логирование ошибок
- Добавлена очистка ресурсов в finally блоке

### 5. Root.kt - Проблемы с sudo командами
**Проблема**: IOException мог быть выброшен, но не обрабатывался в вызывающих функциях.

**Исправления**:
- Добавлена проверка пустых команд
- Улучшена обработка исключений с преобразованием в RuntimeException
- Добавлено логирование выполняемых команд
- Добавлена обработка кодов завершения

### 6. ACE.kt - Проблемы с attach и получением процессов
**Проблема**: Неполная обработка ошибок в функции Attach и новых функциях получения процессов.

**Исправления**:
- Добавлена полная обработка ошибок в функции Attach
- Добавлено время ожидания запуска сервера
- Добавлена проверка жизнеспособности потока сервера
- Добавлена верификация коммуникации с сервером
- Добавлена очистка ресурсов при неудачном attach
- Улучшена обработка ошибок в ListRunningProcFull и ListRunningProcWithArgs
- Добавлена валидация PID
- Добавлен fallback к оригинальному методу при ошибках

### 7. Process.kt - Неполная обработка исключений
**Проблема**: try-catch блок не охватывал все потенциальные точки сбоя.

**Исправления**:
- Добавлена проверка на null для ACE
- Расширена обработка исключений на все этапы процесса attach
- Добавлена обработка ошибок при отключении от предыдущего процесса
- Улучшены сообщения об ошибках
- Добавлена улучшенная обработка ошибок в refreshProcList
- Добавлен fallback механизм при сбое получения списка процессов

## Дополнительные улучшения

### Логирование
- Добавлено подробное логирование во все критические точки
- Используется Android Log для лучшей интеграции
- Добавлены разные уровни логирования (DEBUG, INFO, WARN, ERROR)

### Отказоустойчивость
- Добавлены fallback механизмы для критических функций
- Реализованы retry логики для сетевых операций
- Добавлена очистка ресурсов при сбоях

### Валидация данных
- Добавлена проверка PID на числовые значения
- Добавлена проверка существования файлов
- Добавлена валидация входных параметров

## Результат

После внесения этих исправлений:

1. **Стабильность**: ATG должен стать более стабильным при выборе процессов для attach
2. **Диагностика**: Подробное логирование поможет в диагностике проблем
3. **Отказоустойчивость**: Приложение должно лучше справляться с ошибками
4. **Восстановление**: При сбоях используются fallback механизмы

## Рекомендации по использованию

1. **Проверьте логи**: При проблемах смотрите логи Android с тегом "ATG"
2. **Root права**: Убедитесь, что приложение имеет root права
3. **Бинарные файлы**: Проверьте, что все необходимые бинарные файлы ACE установлены
4. **Перезапуск**: При серьезных проблемах перезапустите приложение

## Мониторинг

Добавленное логирование позволит отслеживать:
- Успешность подключений к серверу ACE
- Время выполнения операций
- Причины сбоев
- Использование fallback механизмов

Эти исправления должны значительно снизить количество вылетов ATG при выборе процессов для attach.