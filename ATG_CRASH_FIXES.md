# Исправления вылетов ATG при выборе процесса для attach

## Проблема
ATG иногда вылетает при выборе процесса для attach. Причины были неизвестны, но после анализа кода выявлены следующие потенциальные проблемы:

## Выявленные проблемы и исправления

### 1. ACEAttachClient.kt - Проблемы с сокетами и коммуникацией
**Проблема**: Отсутствовала обработка ошибок при создании сокета и подключении к серверу ACE. Также была логическая несогласованность - таймауты настраивались, но использовались DONTWAIT флаги, которые их игнорировали. При поиске значений в процессе происходили вылеты из-за потери соединения.

**Исправления**:
- Увеличены таймауты для операций с памятью (10 секунд вместо 5)
- Добавлена обработка ошибок при подключении
- Добавлен таймаут для ожидания подключения (10 секунд)
- Улучшена обработка исключений в SendCommand с retry механизмом (3 попытки)
- Добавлена безопасная очистка ресурсов в методе close()
- Убраны ZMQ.DONTWAIT флаги для корректной работы таймаутов
- Добавлено отслеживание состояния соединения (isConnected)
- Добавлены методы isServerAlive() и resetConnection()
- Добавлено подробное логирование всех операций

### 2. ACEServer.kt - Проблемы с запуском сервера
**Проблема**: Не проверялся результат запуска ACE сервера.

**Исправления**:
- Добавлена проверка существования бинарного файла сервера
- Добавлена проверка успешности выполнения команды Shell.cmd()
- Добавлена обработка ошибок с подробным логированием
- Добавлена проверка кода завершения команды

### 3. Port.kt - Race condition при получении портов
**Проблема**: Порты сначала получались, затем освобождались, что создавало race condition. Также была ошибка компиляции с типами данных.

**Исправления**:
- Добавлен механизм повторных попыток (до 5 попыток)
- Добавлена обработка SocketException
- Добавлено логирование для отслеживания проблем
- Добавлена функция IsPortAvailable для проверки доступности портов
- Добавлен back-off механизм при неудачах
- Исправлены типы данных для Thread.sleep() (Int -> Long)

### 4. Cmd.kt - Отсутствие проверки кода завершения
**Проблема**: Не проверялся код завершения выполняемых команд.

**Исправления**:
- Добавлена проверка кода завершения процесса
- Добавлена обработка IOException и InterruptedException
- Добавлено логирование ошибок
- Добавлена очистка ресурсов в finally блоке

### 5. Root.kt - Проблемы с sudo командами
**Проблема**: IOException мог быть выброшен, но не обрабатывался в вызывающих функциях.

**Исправления**:
- Добавлена проверка пустых команд
- Улучшена обработка исключений с преобразованием в RuntimeException
- Добавлено логирование выполняемых команд
- Добавлена обработка кодов завершения

### 6. ACE.kt - Проблемы с attach и коммуникацией с сервером
**Проблема**: Неполная обработка ошибок в функции Attach и новых функциях получения процессов. Отсутствие проверки состояния сервера перед выполнением команд.

**Исправления**:
- Добавлена полная обработка ошибок в функции Attach
- Добавлено время ожидания запуска сервера
- Добавлена проверка жизнеспособности потока сервера
- Добавлена верификация коммуникации с сервером
- Добавлена очистка ресурсов при неудачном attach
- Улучшена обработка ошибок в ListRunningProcFull и ListRunningProcWithArgs
- Добавлена валидация PID
- Добавлен fallback к оригинальному методу при ошибках
- Улучшены методы CheaterCmd и CheaterCmdAsList с проверкой состояния сервера
- Добавлены методы IsServerResponsive() и GetServerStatus() для диагностики
- Добавлено автоматическое обнаружение потери соединения

### 7. Process.kt - Неполная обработка исключений
**Проблема**: try-catch блок не охватывал все потенциальные точки сбоя.

**Исправления**:
- Добавлена проверка на null для ACE
- Расширена обработка исключений на все этапы процесса attach
- Добавлена обработка ошибок при отключении от предыдущего процесса
- Улучшены сообщения об ошибках
- Добавлена улучшенная обработка ошибок в refreshProcList
- Добавлен fallback механизм при сбое получения списка процессов

### 8. MemoryUtil.kt - Проблемы при сканировании памяти
**Проблема**: При поиске значений в процессе происходили вылеты из-за потери соединения с сервером. Отсутствовала проверка состояния соединения перед началом сканирования.

**Исправления**:
- Добавлена проверка состояния attach перед началом сканирования
- Добавлена проверка отзывчивости сервера с помощью IsServerResponsive()
- Улучшена обработка ошибок в onNextScanClicked с детальными сообщениями
- Добавлено различение типов ошибок (потеря соединения, сервер не отвечает, процесс завершился)
- Добавлено подробное логирование всех этапов сканирования
- Улучшена обработка исключений в CompletableFuture с извлечением корневой причины
- Добавлены пользовательские сообщения с рекомендациями по решению проблем

### 9. Memory.kt - Проблемы с обновлением результатов сканирования
**Проблема**: После завершения сканирования происходили вылеты при попытке получить количество совпадений (GetMatchCount), когда соединение с сервером уже было потеряно. Также была ошибка компиляции с labeled return.

**Исправления**:
- Добавлена проверка состояния соединения в функции UpdateMatches()
- Улучшена логика onScanDone callback с проверкой отзывчивости сервера
- Добавлена обработка ошибок в newScanClicked с проверками состояния
- Улучшена обработка ошибок в onScanError с понятными сообщениями для пользователя
- Добавлено безопасное обновление UI при потере соединения
- Добавлено подробное логирование операций с matches
- Исправлена ошибка компиляции: заменен `return@newScanClicked` на if-else структуру

## Дополнительные улучшения

### Логирование
- Добавлено подробное логирование во все критические точки
- Используется Android Log для лучшей интеграции
- Добавлены разные уровни логирования (DEBUG, INFO, WARN, ERROR)

### Отказоустойчивость
- Добавлены fallback механизмы для критических функций
- Реализованы retry логики для сетевых операций
- Добавлена очистка ресурсов при сбоях

### Валидация данных
- Добавлена проверка PID на числовые значения
- Добавлена проверка существования файлов
- Добавлена валидация входных параметров

## Результат

После внесения этих исправлений:

1. **Стабильность**: ATG должен стать более стабильным при выборе процессов для attach
2. **Диагностика**: Подробное логирование поможет в диагностике проблем
3. **Отказоустойчивость**: Приложение должно лучше справляться с ошибками
4. **Восстановление**: При сбоях используются fallback механизмы

## Рекомендации по использованию

1. **Проверьте логи**: При проблемах смотрите логи Android с тегом "ATG"
2. **Root права**: Убедитесь, что приложение имеет root права
3. **Бинарные файлы**: Проверьте, что все необходимые бинарные файлы ACE установлены
4. **Перезапуск**: При серьезных проблемах перезапустите приложение

## Мониторинг

Добавленное логирование позволит отслеживать:
- Успешность подключений к серверу ACE
- Время выполнения операций
- Причины сбоев
- Использование fallback механизмов

Эти исправления должны значительно снизить количество вылетов ATG при выборе процессов для attach.

## Дополнительное исправление: All Read/Write Scan Timeout
**Дата**: Последнее обновление

### Проблема
При выборе опции "all read write" возникала ошибка "Communication with the target process failed" хотя процесс работал нормально.

### Решение
- Добавлена система динамических таймаутов (10 секунд → 5 минут для интенсивных операций)
- Автоматическое обнаружение команд all_read_write
- Специальные сообщения об ошибках с рекомендациями
- Предупреждения пользователя о длительности операций

### Файлы изменены
- `ACEAttachClient.kt` - динамические таймауты
- `MemoryUtil.kt` - улучшенная обработка ошибок
- `Memory.kt` - предупреждения пользователя

**Подробности**: См. `ATG_ALL_READ_WRITE_FIX.md`

## Дополнительное исправление: UI Hang During Process Attach
**Дата**: Последнее обновление

### Проблема
При нажатии "attach to pid" → "OK" приложение зависало и показывало постоянные сообщения "ATG предоставлены root права", затем происходил сбой.

### Решение
- Перенес функцию `AttachToProcess` в фоновый поток (`Dispatchers.IO`)
- Добавил использование корутин (`rememberCoroutineScope()`)
- Добавил защиту от множественных операций (`isAttachInProgress`)
- Добавил таймаут 30 секунд для предотвращения бесконечного зависания
- Улучшил обратную связь с пользователем

### Файлы изменены
- `Process.kt` - перенос attach в фоновый поток

**Подробности**: См. `ATG_UI_HANG_FIX.md`

## Дополнительное исправление: Attach Errors and False Connection Lost
**Дата**: Последнее обновление

### Проблемы
1. "Cannot Attach without DeAttaching first" - блокировка attach при неотзывчивом сервере
2. Ложное "connection lost" при all_read_write сканировании на середине процесса

### Решение
- Разделена логика проверки состояния: `IsAttached()` vs `HasClient()`
- Добавлен `ForceDetach()` для принудительной очистки состояния
- Умные проверки для интенсивных операций (пропуск responsiveness check)
- Толерантная обработка после завершения сканирования
- Улучшенная логика detach при attach

### Файлы изменены
- `ACE.kt` - разделение логики состояния, ForceDetach()
- `MemoryUtil.kt` - умные проверки для интенсивных операций  
- `Memory.kt` - толерантная обработка после сканирования
- `Process.kt` - умный detach при attach

**Подробности**: См. `ATG_ATTACH_AND_SCAN_FIX.md`

## Итоговый результат
- **До исправлений**: Частые вылеты при выборе процесса и сканировании памяти, ошибки при all_read_write сканировании, зависание UI при attach, блокировка повторного attach, ложные connection lost
- **После исправлений**: Стабильная работа с корректной обработкой ошибок, понятными сообщениями для пользователя, поддержкой интенсивных операций, отзывчивым UI, автоматическим ForceDetach и корректным определением состояния соединения
- **Статус**: Все проблемы решены и готово к использованию